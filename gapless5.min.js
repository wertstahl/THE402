const gapless5Players={},Gapless5State={None:0,Loading:1,Starting:2,Play:3,Stop:4,Error:5},LogLevel={Debug:1,Info:2,Warning:3,Error:4,None:5};function Gapless5Source(t,s){this.audioPath=s;const e=t;let i=null,a=null,n=null,o=null,r=0,h=0,l=0,u=Gapless5State.None,c=Gapless5State.None,d=0,p=null;this.setVolume=(t=>{null!==i&&(i.volume=t)});const g=t=>{c!==t&&t===Gapless5State.Play&&(r=(new Date).getTime()),c=t,u=Gapless5State.None,e.uiDirty=!0};this.getState=(()=>c),this.unload=(t=>{this.stop(),g(t?Gapless5State.Error:Gapless5State.None),o&&o.abort(),i=null,a=null,n=null,h=0,l=0,e.onunload(this.audioPath)});const f=()=>{c===Gapless5State.Play&&e.onEndedCallback()},y=()=>{this.unload(!0)},b=t=>{o&&(o=null,n=t,l=1e3*t.duration,u===Gapless5State.Play&&c===Gapless5State.Loading?m(!0):null!==i&&u===Gapless5State.None&&this.inPlayState(!0)&&(console.debug(`switching from HTML5 to WebAudio: ${this.audioPath}`),h=i.position,this.setPosition(h,!0)),c===Gapless5State.Loading&&(c=Gapless5State.Stop),e.onload(this.audioPath),e.uiDirty=!0)},k=()=>{c===Gapless5State.Loading&&(c=Gapless5State.Stop,l=1e3*i.duration,u===Gapless5State.Play&&m(!0),e.uiDirty=!0)};this.stop=(()=>{c!==Gapless5State.None&&(e.useWebAudio&&a&&(p&&(window.clearTimeout(p),p=null),a.stop(0)),i&&c!==Gapless5State.Starting&&i.pause(),g(Gapless5State.Stop))});const S=t=>{p&&window.clearTimeout(p),p=window.setTimeout(f,1e3*t/e.playbackRate)},m=()=>{if(this.inPlayState(!0))return;h=Math.max(h,0),(!Number.isFinite(h)||h>=this.getLength())&&(h=0);const t=h/1e3;null!==n?(console.debug(`Playing WebAudio: ${this.audioPath}`),e.context.resume(),(a=e.context.createBufferSource()).connect(e.gainNode),a.buffer=n,a.playbackRate.value=e.playbackRate,a.loop=e.loop&&(e.singleMode||1===e.totalTracks()),S(a.buffer.duration-t),a.start(0,t),e.onplay(this.audioPath),g(Gapless5State.Play)):null!==i&&(console.debug(`Playing HTML5 Audio: ${this.audioPath}`),i.currentTime=t,i.volume=e.gainNode.gain.value,i.loop=e.loop&&(e.singleMode||1===e.totalTracks()),i.playbackRate=e.playbackRate,S(i.duration-t),g(Gapless5State.Starting),i.play().then(()=>{c===Gapless5State.Starting?(g(Gapless5State.Play),e.onplay(this.audioPath)):i.pause()}))};this.inPlayState=(t=>c===Gapless5State.Play||t&&c===Gapless5State.Starting),this.isPlayActive=(t=>this.inPlayState(t)||u===Gapless5State.Play),this.getPosition=(()=>h),this.getLength=(()=>l),this.play=(()=>{c===Gapless5State.Loading?(console.debug(`Queueing ${this.audioPath}`),u=Gapless5State.Play):m()}),this.setPlaybackRate=(t=>{a&&(a.playbackRate.value=t),i&&(i.playbackRate=t),S((l-h)/1e3)}),this.tick=(()=>{if(c===Gapless5State.Play){const t=(new Date).getTime();h+=(t-r)*e.playbackRate,r=t}if(d<1){let t=1;c===Gapless5State.Loading?t=0:i&&i.seekable.length>0&&(t=i.seekable.end(0)/i.duration),d!==t&&(d=t,e.setLoadedSpan(d))}}),this.setPosition=((t,s)=>{h=t,s&&this.inPlayState()&&(this.stop(),this.play())}),this.load=(()=>{if(c===Gapless5State.Loading)return;const{audioPath:t}=this;if(e.onloadstart(t),c=Gapless5State.Loading,e.useWebAudio){const s=t=>{t&&e.context.decodeAudioData(t,t=>{b(t)})};t.startsWith("blob:")?fetch(t).then(t=>{t.blob().then(t=>{(o=new FileReader).onload=(()=>{o&&s(o.result)}),o.readAsArrayBuffer(t),o.error&&y()})}):((o=new XMLHttpRequest).open("get",t,!0),o.responseType="arraybuffer",o.onload=(()=>{o&&s(o.response)}),o.onerror=(()=>{o&&y()}),o.send())}if(e.useHTML5Audio){const s=()=>{const t=new Audio;return t.controls=!1,t.preservesPitch=!1,t.mozPreservesPitch=!1,t.webkitPreservesPitch=!1,t.addEventListener("canplaythrough",k,!1),t.addEventListener("error",y,!1),t};t.startsWith("blob:")?fetch(t).then(t=>{t.blob().then(t=>{(i=s()).srcObject=t,i.load()})}):((i=s()).src=t,i.load())}})}function Gapless5FileList(t,s=-1){this.sources=[],this.startingTrack=0,this.trackNumber=-1,this.shuffledIndices=[],this.shuffleMode=Boolean(t),this.shuffleRequest=null,this.preserveCurrent=!0,this.loadLimit=s,this.setStartingTrack=(t=>{this.startingTrack="random"===t?Math.floor(Math.random()*this.sources.length):t||0,console.debug(`Setting starting track to ${this.startingTrack}`),this.trackNumber=this.startingTrack}),this.gotoTrack=((t,s,a,n)=>{const o=this.getSourceIndex(this.trackNumber),r=this.sources[o].isPlayActive(),h=()=>(n(!0),(s||r)&&this.sources[o].play(),this.trackNumber),l="string"==typeof t?this.findTrack(t):t,u=(t=>null!==this.shuffleRequest?this.shuffleRequest?(this.shuffleRequest=null,e(t)):(this.shuffleRequest=null,i(t)):t)(l);this.trackNumber=a?u:l,console.debug(`Setting track number to ${this.trackNumber}`),this.updateLoading();const c=this.getSourceIndex(this.trackNumber);return o===c?h():(n(!0),this.sources[o].stop(),(s||r)&&this.sources[c].play(),this.trackNumber)});const e=t=>{const s=Array.from(Array(this.sources.length).keys());for(let t=0;t<s.length-1;t++){const e=t+Math.floor(Math.random()*(s.length-t));[s[e],s[t]]=[s[t],s[e]]}if(this.preserveCurrent&&this.trackNumber===s[t]&&([s[this.trackNumber],s[t]]=[s[t],s[this.trackNumber]]),JSON.stringify(s)===JSON.stringify(Array.from(Array(this.sources.length).keys()))){const t=s.filter(t=>t!==this.trackNumber),e=Math.floor(Math.random()*t.length),i=(e+1)%t.length,a=s[t[e]],n=s[t[i]];[s[a],s[n]]=[s[n],s[a]]}return this.shuffledIndices=s,this.shuffleMode=!0,console.debug(`Shuffled tracks: ${this.shuffledIndices}`),t},i=t=>(this.shuffleMode=!1,console.debug("Disabling shuffle"),this.preserveCurrent&&this.shuffledIndices[this.trackNumber]===t?(t+1)%this.numTracks():t);this.lastIndex=((t,s,e)=>{const i=s[t];for(let t=0;t<e.length;t++)if(e[t].index===i.index)return t;return 0}),this.removeAllTracks=(t=>{for(let t=0;t<this.sources.length;t++)this.sources[t].unload();t&&(this.shuffledIndices=[],this.setStartingTrack(-1)),this.sources=[]}),this.setPlaybackRate=(t=>{for(let s=0;s<this.sources.length;s++)this.sources[s].setPlaybackRate(t)}),this.setShuffle=((t,s=!0)=>{this.shuffleRequest=t,this.preserveCurrent=s,s||e(this.trackNumber)}),this.isShuffled=(()=>null!==this.shuffleRequest?this.shuffleRequest:this.shuffleMode),this.numTracks=(()=>this.sources.length),this.getTracks=(()=>{const t=[];for(let s=0;s<this.numTracks();s++){const e=this.getSourceIndex(s);t.push(this.sources[e].audioPath)}return t}),this.findTrack=(t=>this.getTracks().indexOf(t)),this.getSourceIndex=(t=>this.shuffleMode?this.shuffledIndices[t]:t),this.getPlaylistIndex=(t=>this.shuffleMode?this.shuffledIndices.indexOf(t):t);const a=(t,s)=>Array.from({length:1+s-t},(s,e)=>e+t);this.loadableTracks=(()=>{if(-1===this.loadLimit)return a(0,this.sources.length);const t=Math.round(Math.max(0,this.trackNumber-(this.loadLimit-1)/2)),s=Math.round(Math.min(this.sources.length,this.trackNumber+this.loadLimit/2)),e=a(t,s);return console.debug(`loadable playlist: ${JSON.stringify(e)}`),e}),this.updateLoading=(()=>{const t=this.loadableTracks();for(const[s,e]of this.sources.entries()){const i=this.getPlaylistIndex(s),a=t.includes(i);a===(e.getState()===Gapless5State.None)&&(a?(console.debug(`Loading track ${i}: ${e.audioPath}`),e.load()):(console.debug(`Unloading track ${i}: ${e.audioPath}`),e.unload()))}}),this.add=((t,s,e)=>{const i=new Gapless5Source(e,s);this.sources.splice(t,0,i),this.shuffledIndices.splice(Math.floor(Math.random()*this.numTracks()),0,this.numTracks()-1),(t<=this.trackNumber||-1===this.trackNumber)&&(this.trackNumber=this.trackNumber+1,console.debug(`Shifting track number to ${this.trackNumber}`)),this.updateLoading()}),this.remove=(t=>{this.sources.splice(t,1),this.shuffledIndices.splice(this.shuffledIndices.indexOf(t),1),this.trackNumber>0&&(t<this.trackNumber||t>=this.numTracks()-2)&&(this.trackNumber=this.trackNumber-1,console.debug(`Decrementing track number to ${this.trackNumber}`)),this.updateLoading()})}function Gapless5(t={},s={}){"string"==typeof t&&(console.warn('Using deprecated API.  Pass element id into options as "guiId"'),t={...s,guiId:t});const e="loadingâ€¦",i="error!";switch(this.hasGUI=!1,this.scrubWidth=0,this.scrubPosition=0,this.isScrubbing=!1,this.tickMS=27,this.initialized=!1,this.uiDirty=!0,this.playlist=new Gapless5FileList(t.shuffle,t.loadLimit),t.logLevel||LogLevel.Info){case LogLevel.None:console.error=(()=>{});case LogLevel.Error:console.warn=(()=>{});case LogLevel.Warning:console.log=(()=>{});case LogLevel.Info:console.debug=(()=>{});case LogLevel.Debug:}this.loop=t.loop||!1,this.singleMode=t.singleMode||!1,this.exclusive=t.exclusive||!1,this.useWebAudio=!1!==t.useWebAudio,this.useHTML5Audio=!1!==t.useHTML5Audio,this.playbackRate=t.playbackRate||1,this.id=Math.floor(65536*(1+Math.random())),gapless5Players[this.id]=this,void 0===window.gapless5AudioContext&&"undefined"!=typeof AudioContext&&(window.gapless5AudioContext=new AudioContext),this.context=window.gapless5AudioContext,this.gainNode=void 0!==this.context?this.context.createGain():null,this.context&&this.gainNode&&(this.gainNode.gain.value=void 0!==t.volume?t.volume:1,this.gainNode.connect(this.context.destination)),this.isPlayButton=!0,this.keyMappings={},this.onprev=(()=>{}),this.onplayrequest=(()=>{}),this.onplay=(()=>{}),this.onpause=(()=>{}),this.onstop=(()=>{}),this.onnext=(()=>{}),this.onerror=(()=>{}),this.onloadstart=(()=>{}),this.onload=(()=>{}),this.onunload=(()=>{}),this.onfinishedtrack=(()=>{}),this.onfinishedall=(()=>{});const a=()=>{const{isScrubbing:t,scrubPosition:s}=this;return(t?s:this.currentSource().getPosition())/this.currentSource().getLength()*65535},n=t=>t/65535*this.currentSource().getLength();this.getIndex=((t=!1)=>{if(null!==this.playlist){const{trackNumber:s}=this.playlist;return t?this.playlist.getSourceIndex(s):s}return-1});const o=t=>{let s=Math.floor(t/6e4);const e=(t-6e4*s)/1e3;let i=Math.floor(e),a=Math.floor(100*(e-i));return s<10&&(s=`0${s}`),i<10&&(i=`0${i}`),a<10&&(a=`0${a}`),`${s}:${i}.${a}`},r=()=>{let t=e;if(0===this.totalTracks())return t;const s=this.currentSource(),a=s.getLength();return 0===this.totalTracks()?t=o(0):s.state===Gapless5State.Error?t=i:a>0&&(t=o(a)),t},h=t=>document.getElementById(`${t}${this.id}`);this.totalTracks=(()=>null!==this.playlist?this.playlist.numTracks():0),this.mapKeys=(t=>{for(let s in t){const e=t[s].toUpperCase().charCodeAt(0),i=t[s].toLowerCase().charCodeAt(0),a=gapless5Players[this.id];Gapless5.prototype.hasOwnProperty.call(a,s)?(this.keyMappings[e]=a[s],this.keyMappings[i]=a[s]):console.error(`Gapless5 mapKeys() error: no function named '${s}'`)}document.addEventListener("keydown",t=>{const s=t.key.charCodeAt(0);s in this.keyMappings&&this.keyMappings[s](t)})}),this.setVolume=(t=>{this.gainNode.gain.value=t,this.currentSource().setVolume(t),this.hasGUI&&(h("volume").value=65535*t)}),this.setGain=(t=>{console.warn("Using deprecated API.  Use setVolume() with value between 0 and 1 instead."),this.setVolume(t/65535)}),this.scrub=((t,s=!1)=>{this.scrubPosition=n(t),this.hasGUI&&(h("currentPosition").innerText=o(this.scrubPosition),u("prev",this.loop||0!==this.getIndex()||0!==this.scrubPosition),s&&(h("transportbar").value=t)),this.isScrubbing||this.currentSource().setPosition(this.scrubPosition,!0)}),this.setLoadedSpan=(t=>{this.hasGUI&&(h("loaded-span").style.width=t*this.scrubWidth,1===t&&(h("totalPosition").innerText=r()))}),this.onEndedCallback=(()=>{const{audioPath:t}=this.currentSource();l(),this.loop||this.getIndex()<this.totalTracks()-1?(this.singleMode||1===this.totalTracks()?this.prev(!0):(this.currentSource().stop(!0),this.next(!0)),this.onfinishedtrack(t)):(this.currentSource().stop(!0),this.onfinishedtrack(t),this.onfinishedall())}),this.onStartedScrubbing=(()=>{this.isScrubbing=!0}),this.onFinishedScrubbing=(()=>{this.isScrubbing=!1,this.currentSource().inPlayState()&&this.scrubPosition>=this.currentSource().getLength()?this.next(!0):this.currentSource().setPosition(this.scrubPosition,!0)}),this.addTrack=(t=>{const s=this.playlist.sources.length;this.playlist.add(s,t,this),this.uiDirty=!0}),this.insertTrack=((t,s)=>{const e=this.totalTracks(),i=Math.min(Math.max(t,0),e);i===e?this.addTrack(s):this.playlist.add(i,s,this),this.uiDirty=!0}),this.getTracks=(()=>this.playlist.getTracks()),this.findTrack=(t=>this.playlist.findTrack(t)),this.removeTrack=(t=>{const s="string"==typeof t?this.findTrack(t):t;if(s<0||s>=this.playlist.numTracks())return;const e=s===this.playlist.trackNumber,i=this.playlist.sources[s];if(!i)return;let a=!1;i.state===Gapless5State.Loading?i.unload():i.inPlayState(!0)&&(a=!0,i.stop()),this.playlist.remove(s),e&&(this.next(),a&&this.play()),this.uiDirty=!0}),this.replaceTrack=((t,s)=>{this.removeTrack(t),this.insertTrack(t,s)}),this.removeAllTracks=((t=!0)=>{this.playlist.removeAllTracks(t),this.uiDirty=!0}),this.isShuffled=(()=>this.playlist.isShuffled()),this.shuffle=((t=!0)=>{this.canShuffle()&&(this.playlist.setShuffle(!0,t),this.uiDirty=!0)}),this.toggleShuffle=(()=>{this.canShuffle()&&(this.playlist.setShuffle(!this.isShuffled()),this.uiDirty=!0)}),this.shuffleToggle=this.toggleShuffle,this.currentSource=(()=>this.playlist.sources[this.getIndex(!0)]),this.setPlaybackRate=(t=>{p(),this.playbackRate=t,this.playlist.setPlaybackRate(t)}),this.gotoTrack=((t,s,e=!1)=>{const i=this.playlist.gotoTrack(t,s,e,l);u("prev",this.loop||!this.singleMode&&i>0),u("next",this.loop||!this.singleMode&&i<this.totalTracks()-1),this.uiDirty=!0}),this.prevtrack=(()=>{if(0===this.totalTracks())return;let t=0;if(this.getIndex()>0)t=this.getIndex()-1;else{if(!this.loop)return;t=this.totalTracks()-1}const s=this.currentSource().audioPath;this.gotoTrack(t),this.onprev(s,this.currentSource().audioPath)}),this.prev=(t=>{if(0===this.totalTracks())return;let s=!0,e=0,i=this.getIndex();if(this.currentSource().getPosition()>0)e=i,s=!1;else if(this.singleMode&&this.loop)e=i;else if(i>0)e=i-1;else{if(!this.loop)return;e=this.totalTracks()-1}const a=this.currentSource().audioPath;this.gotoTrack(e,!0===t),s&&this.onprev(a,this.currentSource().audioPath)}),this.next=(t=>{if(0===this.totalTracks())return;let s=0,e=this.getIndex();if(this.singleMode)s=e;else if(e<this.totalTracks()-1)s=e+1;else if(!this.loop)return;const i=this.currentSource().audioPath;this.gotoTrack(s,!0===t,!0),this.onnext(i,this.currentSource().audioPath)}),this.play=(()=>{if(0!==this.totalTracks()){if(this.currentSource().play(),this.exclusive){const{id:t}=this;for(const s in gapless5Players)s!==t.toString()&&gapless5Players[s].stop()}this.onplayrequest(this.currentSource().audioPath)}}),this.playpause=(t=>{this.isPlayButton?this.play(t):this.pause(t)}),this.cue=(t=>{this.isPlayButton?this.currentSource().getPosition()>0?(this.prev(t),this.play(t)):this.play(t):this.prev(t)}),this.pause=(()=>{this.totalTracks()>0&&(this.currentSource().stop(),this.onpause(this.currentSource().audioPath))}),this.stop=(()=>{this.totalTracks()>0&&(this.currentSource().stop(!0),l(),this.onstop(this.currentSource().audioPath))}),this.isPlaying=(()=>this.currentSource().inPlayState());const l=t=>{(t||this.currentSource().getPosition()>0)&&this.scrub(0,!0)},u=(t,s)=>{if(this.hasGUI){const e=h(t);if(e){const{classList:t}=e;t.remove(s?"disabled":"enabled"),t.add(s?"enabled":"disabled")}}},c=(t,s)=>{const e=h("shuffle");if(e){const i="shuffle"===t;e.classList.remove(i?"g5unshuffle":"g5shuffle"),e.classList.add(i?"g5shuffle":"g5unshuffle"),u("shuffle",s)}};this.canShuffle=(()=>this.totalTracks()>2);const d=()=>{this.hasGUI&&(0===this.totalTracks()?(h("trackIndex").innerText="0",h("tracks").innerText="0",h("totalPosition").innerText="00:00.00",u("prev",!1),c("shuffle",!1),u("next",!1)):(h("trackIndex").innerText=this.playlist.trackNumber,h("tracks").innerText=this.totalTracks(),h("totalPosition").innerText=r(),u("prev",this.loop||this.getIndex()>0||this.currentSource().getPosition()>0),u("next",this.loop||this.getIndex()<this.totalTracks()-1),this.currentSource().inPlayState(!0)?(u("play",!1),this.isPlayButton=!1):(u("play",!0),this.isPlayButton=!0,this.currentSource().state===Gapless5State.Error&&this.onerror(this.currentSource().audioPath)),c(this.isShuffled()?"unshuffle":"shuffle",this.canShuffle())))},p=()=>{if(this.totalTracks()>0&&(this.currentSource().tick(),this.uiDirty&&(this.uiDirty=!1,d()),this.currentSource().inPlayState())){let t=this.currentSource().getPosition();this.isScrubbing&&(t=this.scrubPosition),this.hasGUI&&(h("transportbar").value=a(),h("currentPosition").innerText=o(t))}window.setTimeout(()=>{p()},this.tickMS)},g=t=>{const{id:s}=this,i=t=>`\n    <div class="g5position" id="g5position${s}">\n      <span id="currentPosition${s}">00:00.00</span> |\n      <span id="totalPosition${s}">${e}</span> |\n      <span id="trackIndex${s}">1</span>/<span id="tracks${s}">1</span>\n    </div>\n    <div class="g5inside" id="g5inside${s}">\n      ${t}\n    </div>\n  `;return"undefined"==typeof Audio?(this.hasGUI=!1,i("This player is not supported by your browser.")):i(`\n    <div class="g5transport">\n      <div class="g5meter" id="g5meter${s}"><span id="loaded-span${s}" style="width: 0%"></span></div>\n        <input type="range" class="transportbar" name="transportbar" id="transportbar${s}"\n        min="0" max="65535" value="0" oninput="${t}.scrub(this.value);"\n        onmousedown="${t}.onStartedScrubbing();" ontouchstart="${t}.onStartedScrubbing();"\n        onmouseup="${t}.onFinishedScrubbing();" ontouchend="${t}.onFinishedScrubbing();" />\n      </div>\n    <div class="g5buttons" id="g5buttons${s}">\n      <button class="g5button g5prev" id="prev${s}"></button>\n      <button class="g5button g5play" id="play${s}"></button>\n      <button class="g5button g5stop" id="stop${s}"></button>\n      <button class="g5button g5shuffle" id="shuffle${s}"></button>\n      <button class="g5button g5next" id="next${s}"></button>\n      <input type="range" id="volume${s}" class="volume" name="gain" min="0" max="65535"\n        value="65535" oninput="${t}.setVolume(this.value / 65535);"\n      />\n    </div>\n  `)},f=t.guiId?document.getElementById(t.guiId):null;if(f){this.hasGUI=!0,f.insertAdjacentHTML("beforeend",g(`gapless5Players[${this.id}]`)),-1===navigator.userAgent.indexOf("macOS")&&h("transportbar").classList.add("g5meter-1pxup");const s=(t,s)=>{const e=h(t);e&&e.addEventListener("mousedown",s)};if(s("prev",this.prev),s("play",this.playpause),s("stop",this.stop),s("shuffle",this.toggleShuffle),s("next",this.next),u("play",!0),u("stop",!0),!1===t.shuffleButton){const t=(t,s)=>{const e=h(t);e&&(e.style.width=s)},s="111px",e="115px";t("transportbar",s),t("g5meter",s),t("g5position",e),t("g5inside",e),h("shuffle").remove()}this.scrubWidth=h("transportbar").style.width}if("undefined"!=typeof Audio){if("startingTrack"in t&&("number"==typeof t.startingTrack?this.startingTrack=t.startingTrack:"string"==typeof t.startingTrack&&"random"===t.startingTrack&&(this.startingTrack="random")),"mapKeys"in t&&this.mapKeys(t.mapKeys),"tracks"in t){let s=[],e=0;if(Array.isArray(t.tracks)){if("string"==typeof t.tracks[0]){s=t.tracks;for(let e=0;e<t.tracks.length;e++)s[e]=t.tracks[e]}else if("object"==typeof t.tracks[0]){for(let e=0;e<t.tracks.length;e++)s[e]=t.tracks[e].file;e=this.startingTrack||0}}else"string"==typeof t.tracks&&(s[0]=t.tracks);for(let t=0;t<s.length;t++)this.addTrack(s[t]);this.playlist.setStartingTrack(e)}this.initialized=!0,this.uiDirty=!0,p()}else console.error("This player is not supported by your browser.")}